# Before you start

Make sure you have these installed.

- aws cli
- sls
- node
- yarn
- npm
- @prisma/cli as global npm dep

# After you have your Saruni app

- add accessToken to .env
- add refreshToken to .env
- add DATABASE_URL to .env

# Deployment to dev environment

- create root aws account
- create aws organization
- create dev account
- create cli access on dev account
- copy access_key_id and secret_key_id to `~/.aws/credentials` under a new profile
- add the name of the profile to `saruni.json` under serverless.dev.awsProfile
- create bastion key with command `yarn sr create-key`
- add project name to `saruni.json`
- create env vars in aws system manager in a format like: `/${yourProjectName}/DBName/dev`
- deploy resource with `yarn deploy --service=resources`
- copy the cloudfront domain to `saruni.json` under serverless.dev.fortendUrl **and** serverless.dev.cloudfrontUrl and **prefix** the domain with `https://`
- deploy the graphql service with `yarn sr deploy --resource=graphql`
- copy the the endpoint of the API without the `/graphql`, like `https://4v9v16mc76.execute-api.eu-west-1.amazonaws.com/dev`, to `saruni.json`, and in there serverless.dev.domainUrl
- copy the name of your frontendBucket from S3 to `saruni.json`, serverless.dev.frontendS3Bucket, it should be something lik `resources-dev-frontendbucket-1stc7i12ez8nh`
- copy the your cloudfront ditribution id (`E6ABKOF10NAN7`) to `saruni.json` serverless.dev.distId
- deploy the web service with `yarn sr deploy --stage=web`
- deploy the auth service with `yarn sr deploy --stage=auth`
- create an ssh tunnel with the command `ssh -L 2222:${yourDBPort}:5432 -i dev-bastion-key.pem ec2-user@${yourEC2domain}`
- in another tab do the migration with `yarn sr db migrate up --stage=dev`

# Deployment to prod environment

- create a prod account
- create cli access on prod account
- copy access_key_id and secret_key_id to `~/.aws/credentials` under a new profile
- add the name of the profile to `saruni.json` under serverless.prod.awsProfile
- create bastion key with command `yarn sr create-key --stage=prod`
- buy your domain (easiest way is through AWS / Route53)
- add what domain you would like your API in `saruni.json` serverless.prod.domainName, like `chat-api.saruni-samples.com`
- add what web domain you would like your web to serverless.prod.frontendDomain in `saruni.json`, like `chat.saruni-samples.com`
- add what web url you would like your web to serverless.prod.frontendUrl in `saruni.json`, like `https://chat.saruni-samples.com`
- create ssl ceritifcate for your domain, with name of your domain and alternate name prefixed with wildcard, like `saruni-samples.com` and `*.saruni-samples.com`
- add the arn of your ssl certifacte to serverless.prod.certificateArn
- add the hosted zone id of your chosen domain to serverless.prod.hostedZoneId
- create env vars in aws system manager in a format like: `/${yourProjectName}/DBName/prod`
- deploy resources with `yarn deploy --service=resources --stage=prod`
- copy the cloudfront domain to `saruni.json` under serverless.prod.cloudfrontUrl and **prefix** the domain with `https://`
- copy the name of your frontendBucket from S3 to `saruni.json` under serverless.dev.frontendS3Bucket, it should be something like `resources-dev-frontendbucket-1stc7i12ez8nh`
- copy the your cloudfront ditribution id (like `E6ABKOF10NAN7`) to `saruni.json` serverless.dev.distId
- create custom domain for your API with `yarn sr deploy --service=domain`
- deploy the graphql service with `yarn sr deploy --resource=graphql`
- deploy the web service with `yarn sr deploy --stage=web`
- deploy the auth service with `yarn sr deploy --stage=auth`
- create an ssh tunnel with the command `ssh -L 2222:${yourDBPort}:5432 -i dev-bastion-key.pem ec2-user@${yourEC2domain}`
- in another tab do the migration with `yarn sr db migrate up --stage=prod`
